# vk Instance

实例是应用程序与`Vulkan Library`之间沟通的桥梁；
`Vulkan API`使用`vkInstance`对象来存储所有每个应用程序的状态；

# Validation Layer

`Vulkan API`的设计核心是尽量最小化驱动程序的额外开销，所谓额外开销更多的是指渲染以外的运算，其中一个具体的表现就是默认条件下，`Vulkan API`的错误检查的支持非常有限；
即使遍历不正确的值或者将需要的参数传递为空指针，也不会有明确的处理逻辑，并且直接导致崩溃或者未定义的异常行为；

`Vulkan`推出了一个优化的系统，这个系统称之为`Validation layers`，`Validation layers`是可选组件，可以挂载到`Vulkan`函数中调用，以回调其他的操作；

功能有：
1. **错误检测**：验证层可以帮助开发者检测程序中的错误。例如，当你使用不正确的参数调用Vulkan函数时，验证层会生成一个错误消息，告诉你哪里出了问题。这可以帮助你更快地找到并修复错误。  
  
2. **性能警告**：验证层还可以检测潜在的性能问题。例如，当你使用低效的渲染路径时，验证层可能会生成一个警告消息，建议你使用更高效的方法。这可以帮助你优化程序的性能。  
  
3. **规范一致性**：验证层可以确保你的程序遵循Vulkan规范。这意味着你的程序在不同的硬件和驱动程序上更有可能正常工作。  
  
4. **调试支持**：验证层可以与调试器一起使用，以提供更详细的调试信息。例如，当你在调试器中设置一个断点时，验证层可以显示与当前Vulkan命令相关的所有参数和状态。这可以帮助你更容易地理解程序的运行情况。

要在Vulkan程序中启用验证层，你需要在创建`VkInstance`时指定所需的验证层；

验证层会造成性能上的损失，因此一般在发布版本中禁用Validation Layer；

# Window Surface

Vulkan是一个与平台特性无关联的API集合，它不能直接与窗口系统进行交互，为了将渲染结果呈现到屏幕，需要建立Vulkan与窗口系统之间的连接；
简单来说，`Window Surface`就是Vulkan与窗口系统之间的桥梁；

`VkSurfaceKHR`是Window Surface的一个抽象类型，使用该类型需要拓展`VK_KHR_Surface`的支持（该拓展已在`glfwGetRequiredInstanceExtensions`中获取）；

# Queue Family

队列族是一组具有相似特性的队列，这些队列可以执行各种类型的操作，如图形渲染、计算任务和数据传输。每个队列族都有一个或多个队列，这些队列可以**并行执行**任务。  
  
Vulkan设备（如GPU）上的不同队列族可能**具有不同的性能特征和功能**。例如，某些队列族可能专门用于图形渲染，而其他队列族可能更适合执行计算任务。在Vulkan应用程序中，开发人员需要根据任务的需求选择合适的队列族。

队列族**可能同时支持多种操作**，例如，一个队列族可能既支持图形渲染操作，也支持计算操作；

队列族的种类有：
1. **图形（Graphics）队列族**：这些队列族用于执行图形渲染操作，例如绘制三维场景。要检查一个队列族是否支持图形操作，可以检查其是否具有`VK_QUEUE_GRAPHICS_BIT`标志。  
  
2. **计算（Compute）队列族**：这些队列族专门用于执行计算任务，例如在GPU上运行计算着色器。要检查一个队列族是否支持计算操作，可以检查其是否具有`VK_QUEUE_COMPUTE_BIT`标志。  
  
3. **传输（Transfer）队列族**：这些队列族用于执行数据传输操作，例如从CPU内存复制数据到GPU内存。要检查一个队列族是否支持传输操作，可以检查其是否具有`VK_QUEUE_TRANSFER_BIT`标志。
  
4. **稀疏绑定（Sparse Binding）队列族**：这些队列族用于处理稀疏资源绑定操作，例如在使用稀疏纹理时。要检查一个队列族是否支持稀疏绑定操作，可以检查其是否具有`VK_QUEUE_SPARSE_BINDING_BIT`标志。  
  
5. **保护（Protected）队列族**：这些队列族用于执行受保护的操作，例如在使用受保护的内存时。要检查一个队列族是否支持保护操作，可以检查其是否具有`VK_QUEUE_PROTECTED_BIT`标志。

---
6. **呈现（Present）队列族**：呈现队列**不是一个独立的队列族类型**，而是与其他队列族（如图形队列族）**共享的功能**，作为一种特殊类型的队列，其功能是将渲染好的图像显示到屏幕上。呈现队列通常与图形队列（Graphics Queue）一起使用，以实现图形渲染和显示的完整流程；一般支持Graphic的队列族也支持Present；

# Swap Chain

交换链是一个用于在屏幕上呈现图像的关键概念。它是一系列图像（称为帧缓冲）的集合，这些图像在GPU和显示设备之间交换，以便在屏幕上显示。交换链的主要目的是在屏幕上显示渲染的图像，同时避免撕裂和卡顿现象。

# Image View

图像视图（Image View）是一个用于访问图像资源的关键概念。图像视图定义了如何将图像资源映射到管线阶段，以便在渲染过程中使用。它可以用于访问图像的特定部分，例如颜色、深度或模板。图像视图还可以用于指定图像的格式、类型和范围。

图像试图的作用有：
1. **访问图像资源**： 图像视图允许您在渲染过程中访问图像资源。例如，您可以将图像视图绑定到描述符集，以便在着色器中使用。

2. **指定图像格式和类型**： 图像视图允许您为图像资源指定格式和类型。这对于正确解释图像数据非常重要，因为它决定了如何将图像数据映射到管线阶段。

3. **访问图像的特定部分**： 图像视图允许您访问图像的特定部分，例如颜色、深度或模板。这对于实现多种渲染效果非常有用，例如阴影映射、环境光遮蔽等。

# Render Pass

渲染通道（Render Pass）是一个描述渲染操作的关键概念。它定义了一系列子通道（Subpasses）和附着（Attachments），这些子通道和附着用于在渲染过程中读取、写入和存储图像数据。渲染通道还描述了子通道之间的依赖关系，以确保正确的执行顺序和同步。

渲染通道的组成部分：
1. **子通道（Subpasses）**： 子通道是渲染通道中的一个阶段，用于执行特定的渲染操作，例如几何处理、光照计算等。子通道可以访问渲染通道中定义的附着，并根据需要读取和写入图像数据。

2. **附着（Attachments）**： 附着是渲染通道中的图像资源，用于存储渲染过程中生成的数据，例如颜色、深度和模板数据。附着可以在子通道之间共享，以便在渲染过程中重用图像数据。

3. **依赖关系（Dependencies）**： 依赖关系描述了子通道之间的执行顺序和同步要求。这确保了渲染操作按照正确的顺序执行，并避免了潜在的竞争条件和数据冲突。

## Subpass

subpass（子通道）是渲染管线（render pipeline）中的一个概念。它是渲染过程中的一个阶段，用于处理渲染操作的一部分。一个渲染管线可以包含多个子通道，这些子通道按顺序执行，以完成整个渲染过程。

子通道的主要作用是允许在不同的渲染阶段之间共享资源，例如图像和缓冲区。这可以提高渲染性能，因为它减少了内存带宽的需求和资源的重复使用。子通道之间的依赖关系通过依赖描述符（`dependency descriptors`）来定义，这些描述符指定了子通道之间的执行顺序和资源访问权限。

## Attachment

attachment（附件）是一个用于存储图像数据的内存对象。它通常用于渲染过程中的输入和输出，例如颜色缓冲区、深度缓冲区和模板缓冲区。在Vulkan渲染管线中，附件是通过`VkAttachmentDescription`结构体进行描述的，它包含了附件的格式、样本数、加载和存储操作等信息。

### Attachment Type

1. **颜色附件**（Color Attachment）：颜色附件用于存储渲染过程中生成的像素颜色值。在渲染管线的最后阶段，片段着色器输出的颜色值会被写入到颜色附件中。通常，颜色附件会关联到一个图像视图（image view），这个图像视图可以是一个纹理或者一个帧缓冲区。

2. **深度附件**（Depth Attachment）：深度附件用于存储渲染过程中生成的像素深度值。在渲染管线的早期阶段，深度测试会使用深度附件中的值来决定一个像素是否应该被绘制。深度附件通常与一个深度图像视图关联。

3. **模板附件**（Stencil Attachment）：模板附件用于存储渲染过程中生成的像素模板值。模板测试会使用模板附件中的值来决定一个像素是否应该被绘制。模板附件通常与一个模板图像视图关联。

4. **深度模板附件**（Depth Stencil Attachment）：深度模板附件是深度附件和模板附件的组合，它们共享同一个图像视图。这种类型的附件可以同时用于深度测试和模板测试。

这些附件类型通常在渲染过程中的子通道（subpass）中使用。子通道可以指定它们需要的附件类型，以及如何处理这些附件。

### Attachment Reference

attachment reference（附件引用）主要用于定义渲染过程中的输入和输出资源。它们在渲染过程中扮演着重要的角色，比如：

**颜色附件**：在渲染过程中，颜色附件用于存储渲染管线输出的颜色数据。通常，这些数据会被写入到一个图像中，以便在后续的渲染操作中使用。附件引用可以指定一个颜色附件，以便在渲染过程中使用。
```cpp
VkAttachmentReference colorAttachmentRef = {};
colorAttachmentRef.attachment = 0;
colorAttachmentRef.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;
```

**深度模板附件**：深度模板附件用于存储渲染管线输出的深度和模板数据。这些数据通常用于实现深度测试和模板测试等功能。附件引用可以指定一个深度模板附件，以便在渲染过程中使用。
```cpp
VkAttachmentReference depthStencilAttachmentRef = {};
depthStencilAttachmentRef.attachment = 1;
depthStencilAttachmentRef.layout = VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL;
```

然后在`VkSubpassDescription`中被引用：
```cpp
VkSubpassDescription subpass = {};
subpass.pipelineBindPoint = VK_PIPELINE_BIND_POINT_GRAPHICS;
subpass.colorAttachmentCount = 1;
subpass.pColorAttachments = &colorAttachmentRef;
subpass.pDepthStencilAttachment = &depthStencilAttachmentRef;
```

## Dependency

依赖关系（dependency）是指在渲染过程中，不同操作之间的顺序和同步关系。Vulkan是一个低级别的图形和计算API，它允许开发者更精细地控制渲染管线和资源管理。为了实现这一点，Vulkan提供了一种描述操作之间依赖关系的方法，以确保正确的执行顺序和同步。

在Vulkan中，依赖关系主要通过`VkDependencyFlags`和`VkSubpassDependency`结构体来描述。`VkDependencyFlags`用于指定依赖关系的类型，如图形管线阶段之间的依赖关系、内存访问之间的依赖关系等。`VkSubpassDependency`结构体则用于描述渲染过程中子通道之间的依赖关系，包括源子通道、目标子通道、管线阶段、访问类型等信息。

# Stencil

在Vulkan中，模板（stencil）是一种图形渲染技术，用于控制哪些像素应该被绘制到屏幕上。模板缓冲区（stencil buffer）是一种特殊的缓冲区，用于存储每个像素的模板值。这些值可以用于执行各种操作，例如限制渲染到特定区域或实现阴影效果。

模板测试（stencil test）是在像素着色器（pixel shader）之前执行的一种测试，用于确定像素是否应该被绘制。模板测试根据模板缓冲区中的值和预先定义的模板函数（stencil function）来决定像素是否通过测试。如果像素通过了模板测试，它将继续进行后续的渲染操作，否则它将被丢弃。

模板操作（stencil operations）是在模板测试之后执行的一组操作，用于更新模板缓冲区中的值。这些操作可以根据像素是否通过深度测试（depth test）来选择不同的行为。例如，你可以在像素通过深度测试时递增模板值，而在像素未通过深度测试时保持模板值不变。

总之，在Vulkan中，模板（stencil）是一种用于控制像素渲染的技术，通过模板缓冲区、模板测试和模板操作来实现各种图形效果。

# Descriptor

`Descriptor`是一种描述渲染管线中资源绑定的机制。它可以用来指定着色器程序中使用的缓冲区、图像和采样器等资源。Descriptor可以看作是一种中介，**将着色器程序中的变量与实际的资源绑定**起来。在Vulkan中，Descriptor由`Descriptor Set`和`Descriptor Set Layout`两部分组成。`Descriptor Set Layout`定义了`Descriptor Set`中包含的Descriptor类型和数量，而`Descriptor Set`则实际绑定了资源。

## Descriptor Set

描述符集（`Descriptor Set`）是一组描述符绑定的集合。描述符绑定是指将着色器中的变量与实际的缓冲区、图像等资源进行绑定。descriptorSet中包含了多个描述符绑定，**每个描述符绑定对应一个着色器中的变量**。在渲染时，我们需要将descriptorSet绑定到渲染管线上，以便着色器可以访问到对应的资源。

## Descriptor Set Layout

`Descriptor Set Layout`是一种描述了在渲染过程中使用的`Uniform Buffer Objects`、`Texture Samplers`和`Input Attachments`的布局。它定义了这些资源在着色器中的绑定点和绑定顺序。`Descriptor Set Layout`可以在Pipeline创建时指定，以确保在渲染过程中正确地绑定资源。


# Graphic Pipeline

`Graphic Pipeline`是一种用于渲染图形的流程。它由多个阶段组成，包括顶点输入、顶点着色器、图元装配、几何着色器、光栅化、片段着色器、颜色混合和输出合成。每个阶段都有自己的任务和输入输出，通过这些阶段的组合，可以实现高效的图形渲染。在Vulkan中，Graphic Pipeline是由多个可编程的`Shader Stage`组成的，这些Shader Stage可以使用`SPIR-V`语言编写。

## Shader Module

`Shader Module`是一个包含着色器代码的二进制文件。在Vulkan中，着色器代码必须被编译成`SPIR-V`格式的二进制代码，然后被加载到shader module中。Shader module可以被多个管线使用，因此它可以被看作是**一个可重用的着色器库**。 

## Dynamic State

`Dynamic State`允许应用程序在渲染管线的**执行期间更改某些状态，而无需重新创建管线**。这些状态包括视口、裁剪矩形、线宽、深度偏移和模板比较掩码等。使用Dynamic State可以提高应用程序的性能，因为它避免了在管线创建期间进行状态更改的开销。

## Vertex Input State

`Vertex input state`定义了如何从顶点缓冲区中读取顶点数据。具体来说，它包括顶点缓冲区的绑定描述和顶点属性描述。顶点缓冲区的绑定描述**定义了每个顶点数据的大小和偏移量**，而顶点属性描述定义了**每个顶点数据的格式和位置**。通过这些描述，Vulkan可以正确地解析顶点数据并将其传递给着色器程序。

### Vertex Input Binding Description

`Vertex Input Binding Description`是Vulkan中用于描述顶点输入数据的结构体。它包含了顶点缓冲区的绑定索引、顶点数据的步长和偏移量等信息。在Vulkan中，顶点数据需要通过这个结构体来告诉GPU如何解析顶点数据。

1. 绑定索引；
2. 占用字节数大小（`sizeof(Vertex3D)`）；
3. 传输速率；

### Vertex Input Attribute Description

`Vertex Input Attribute Description`是Vulkan中用于描述顶点输入数据的结构体。它包含了顶点数据的格式、绑定和偏移量等信息。在Vulkan中，顶点数据需要通过Vertex Input Attribute Description来告诉GPU如何解析顶点数据。这个结构体可以通过`VkVertexInputAttributeDescription`来定义，其中包含了location、binding、format和offset等成员变量。其中，location表示顶点着色器中的输入变量索引，binding表示顶点数据的绑定索引，format表示顶点数据的格式，offset表示顶点数据在缓冲区中的偏移量。

1. 绑定索引（与`Vertex Input Binding Description`中一致）；
2. 位置索引（比如pos为0，color为1，texcoord为2...）；
3. 格式（比如color为RGB32，texcoord为RG32）；
4. 偏移量；

## Input Assembly State

`Input Assembly State`指定如何将顶点数据组装成图元，包括是三角形还是举行、是否启用`primitive restart`；

### Primitive Restart

`primitive restart`是Vulkan图形API中的一个功能，它允许在绘制三角形条带时在顶点之间插入一个特殊的索引值，以指示该条带已经结束并且下一个条带已经开始。这个特殊的索引值可以通过调用`vkCmdSetPrimitiveRestartEnable`函数来设置。当启用`primitive restart`时，Vulkan将忽略插入的索引值，并将其视为一个新的三角形条带的开始。


## Viewport

在Vulkan中，渲染管线中的`Viewport`是指用于**定义渲染目标的可见区域**。它是一个矩形区域，用于指定渲染到屏幕上的图像的大小和位置。Viewport可以在管线中进行设置，以便在渲染过程中进行动态更改。Viewport的大小和位置可以通过设置视口变换来进行调整，这可以通过设置视口变换矩阵来实现。

## Scissor Rectangle

在Vulkan中，渲染管线中的`Scissor`是一个矩形区域，用于**指定渲染的区域**。在渲染过程中，只有在该矩形区域内的像素才会被渲染，从而提高了渲染效率。可以通过设置`VkPipelineViewportStateCreateInfo`结构体中的scissor成员变量来指定scissor矩形区域。
# 白炉测试

白炉测试（`White Furnace Test`）是计算机图形学中用于**测试全局光照模型的一种方法**；
基本思想是将场景中的所有表面都设为完全反射，即将所有表面设为白色，然后在场景中放置一个光源；如果全局光照模型正确，那么场景中的所有表面都应该显示为同一亮度的白色，因为所有的光都会被反射并均匀地分布在整个场景中；

这种测试方法可以帮助检查全局光照模型是否正确处理了光的反射和传播；如果模型正确，那么无论观察者在场景中的位置如何，所有的表面都应该显示为同一亮度的白色；如果某些表面比其他表面更亮或更暗，那么这可能意味着模型在处理光的反射和传播时存在问题；

![WhiteFurnace|700](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20230917144001.png)


# 能量补偿

物体表面越粗糙，其子遮挡现象越严重，但这并不以为着能量损失了、粗糙物体就应该更暗，最终能量还是会在多次弹射后反射出去；

也就是说，传统的`PBR`公式中的几何项`G`只考虑了一次反射的情况，但实际上反射是多次的；因此需要对粗糙物体进行能量补偿；

当自遮挡现象发生时，也就意味着下一次的光线弹射的发生；

![pbr|300](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20230917153458.png)


# Kulla-Conty近似

`Kulla-Conty`近似是一种在计算机图形学中用于更准确地模拟微表面传输（`Microfacet Transmission`）的方法；这种方法由Jakob Kulla和Andreas Conty提出，主要用于改进`PBR`中的折射和透射效果；

使用传统的`PBR`在处理高粗糙度表面时可能会产生不准确的结果；`Kulla-Conty`近似通过引入一个新的菲涅尔项来解决这个问题，这个新的菲涅尔项可以更准确地模拟高粗糙度表面的折射和透射效果；

## 计算能量损失

假设渲染方程中入射光线 $L_i=1$，假设菲涅尔项为1（无反射损失），这种情况下，着色点在各个方向的入射的能量等于各个方向出射的总和，再进行积分换元（其中 $\mu=\sin\theta$ ），以此计算一次反射的出射能量：
$$
E(\mu_o)=\int_0^{2\pi}\int_0^1f(\mu_o,\mu_i,\phi)\mu_i\space \mathrm{d}\mu_i\mathrm{d}\phi
$$

理想情况下如果没有能量损失，出射能量等于入射能量等于1，则能量损失为（其值与观察方向有关）：
$$
1-E(\mu_o)
$$

为了补偿这一部分的能量，希望能有一种BRDF，其积分出的结果恰好等于损失的能量；
$$
\int_0^{2\pi}\int_0^1f_{ms}(\mu_o,\mu_i)\mu_i\space \mathrm{d}\mu_i\mathrm{d}\phi=1-E(\mu_o)
$$

除此之外，这个BRDF函数 $f_{ms}(\mu_o,\mu_i)$ 需要满足一些物理条件，如光路的可逆性（`reciprocity`），即入射方向与出射方向互换改函数的值不变；

综上所述，该函数的一种形式为：
$$
f_{ms}(\mu_o,\mu_i) = c(1-E(\mu_i))(1-E(\mu_o))
$$

经过一系列的计算（按下不表），常数 $c$ 的值为：
$$
\begin{align}
c&=\frac{1}{\pi(1-E_{avg})}\\
E_{avg}&=\frac{\int_0^1E(\mu)\mu\mathrm{d}\mu}{\int_0^1\mu\mathrm{d}\mu}=2\int_0^1 E(\mu)\mu \mathrm{d}\mu
\end{align}
$$

验证积分结果：

![KullaConty|450](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20230917155538.png)

$E(\mu)$ 和 $E_{avg}$ 都难以得到解析解，因此使用蒙特卡洛积分等方法求得其数值解，记录在表中用以预计算；
- $E(\mu)$ 与粗糙度及视线角度相关，是一个二维的值；
- $E_{avg}$ 是 $E(\mu)$ 在各个角度的平均值，只与粗糙度相关，是一个一维的值；

![KullaConty|300](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20230917160618.png)

## 假如光有颜色

光线的反射损失主要取决于两个因素：**物体的表面特性**（如光滑度、材质等）和**光线的颜色**（即波长）；不同颜色的光线（即不同波长的光）在相同的物体表面上的反射损失可能会有所不同；这是因为不同波长的光在物体表面上的反射、折射和吸收特性可能会有所不同；

白色光是由多种颜色（即多种波长）的光混合而成的，因此白色光的反射损失与单一颜色的光有所不同，具体的差异取决于物体表面对各种颜色光的反射特性；

先用`Kulla-Conty`近似算出白光情况下的出射能量，再在此基础上减去因为颜色导致的能量损失；

### Avg Fresnel

平均菲涅尔，表示各个视线方向的菲涅尔项的平均，用来表示所有视线角度下光线反射的损失能量；
$$
F_{avg}=\frac{\int_0^1F(\mu)\mu\mathrm{d}\mu}{\int_0^1\mu\mathrm{d}\mu}=2\int_0^1F(\mu)\mu\mathrm{d}\mu
$$

上文中的 $E_{avg}$ 就表示人眼能看到的能量，也就是被反射出的能量、也就是未参与进一步反射的能量，则进一步参与反射的能量就是 $1-E_{avg}$；


无弹射的情况下，出射的能量为：
$$
F_{avg}E_{avg}
$$
一次弹射后，出射的能量为：
$$
F_{avg}E_{avg}*F_{avg}(1-E_{avg})
$$
$k$ 次弹射后，出射的能量为：
$$
F_{avg}E_{avg}*F^k_{avg}(1-E_{avg})^k
$$
当 $k$ 趋近于无穷大后，出射能量的和为（几何级数）：
$$
\frac{F_{avg}E_{avg}}{1-F_{avg}(1-E_{avg})}
$$

使用该系数乘以理想白光情况下的出射能量，作为因颜色反射能量衰减后的出射能量；

## 补偿效果

![KullaConty|700](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20230917161004.png)

![KullaConty|700](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20230917170039.png)

# 误区

**不能使用Diffuse着色来代替Multi Bounce的结果**！

微表面模式是用来做镜面反射的，一个材质不能同时用微表面模型和Diffuse来描述！
（在微表面模型中，粗糙度越高，镜面反射的高光越分散，看起来表面越“哑光”；但这并不等同于漫反射，因为漫反射的光线是均匀分布的，而高粗糙度的微表面模型仍然有一个明显的反射方向）


**Layered Blend Per Bone（按骨骼分层混合）** 是虚幻引擎动画蓝图中最重要的节点之一。

它的核心功能是：**将两个动画按骨骼层级“缝合”在一起。** 例如：让角色的下半身跑动，同时上半身播放招手或开火的动作。

# 1. 节点的基本结构

在 AnimGraph 中搜索并放置该节点，你会看到两个主要输入：
*   **Base Pose (基础动作)**：通常是主状态机（如：站立、奔跑、跳跃）。
*   **Blend Pose 0 (混合动作)**：你想要叠加的局部动作（如：攻击、换弹、挥手）。
*   **Blend Weights (混合权重)**：控制混合动作的影响程度（0 为完全不显示，1 为完全替换）。

# 2. 核心设置：Branch Filters (分支过滤器)

这是该节点**最关键**的步骤。你需要告诉引擎，混合动作从哪根骨骼开始生效。

1.  选中节点，在右侧 **Details (细节)** 面板中找到 **Layer Setup -> Branch Filters**。
2.  点击 **+** 号添加一个元素。
3.  **Bone Name (骨骼名称)**：输入起始骨骼的名字。
    *   *常见案例*：如果你想让上半身独立播放动画，通常填入脊柱骨骼（如 `spine_01` 或 `spine_02`）。
4.  **Blend Depth (混合深度)**：控制过渡的平滑度。
    *   **0**：硬切。该骨骼及其所有子骨骼 100% 使用混合动作，父骨骼 100% 使用基础动作。
    *   **大于 0 (如 3)**：渐进混合。从指定的骨骼向上数 N 层骨骼会产生平滑过渡。这能防止腰部看起来像被折断了一样。


# 3. 重要参数详解

**Mesh Space Rotation Blend (模型空间旋转混合)**
这是该节点中最核心的一个“开关”参数。

*   **不勾选（默认：局部空间 / Local Space）**：
    *   **逻辑**：它将“混合姿势”相对于其父骨骼的旋转，应用到“基础姿势”上。
    *   **效果**：**叠加性**。如果基础姿势（跑步）中脊柱在晃动，混合姿势（拿枪）也会随着这个晃动而晃动。
    *   **适用场景**：大部分常规动作，如跑步时挥手、换弹、播放表情。

*   **勾选（模型空间 / Mesh Space）**：
    *   **逻辑**：它会忽略基础姿势的旋转，直接把混合姿势在模型空间下的旋转“强加”给骨骼。
    *   **效果**：**覆盖性**。无论下半身怎么跑、怎么晃，上半身都会严格保持混合姿势里的角度。
    *   **适用场景**：**瞄准偏移（Aim Offset）**。当你需要角色上半身精准地指向正前方，而不受下半身跑步动作晃动的影响时，必须开启此项。


**Mesh Space Scale Blend (模型空间缩放混合)**
*   类似于旋转混合，决定了骨骼的缩放是基于父骨骼（Local）还是基于整个模型坐标（Mesh）。通常保持默认即可，除非你有特殊的变形动画。


**Curve Blend Options (曲线混合模式)**
动画不仅包含骨骼旋转，还包含**动画曲线**（比如用于驱动表情的 Morph Target 或自定义参数）。这个参数决定了当两个姿势都有同名曲线时该听谁的：

*   **Override（覆盖）**：混合姿势的曲线值直接覆盖基础姿势。
*   **Do Not Blend（不混合）**：只保留基础姿势的曲线。
*   **Normalize By Weight（按权重归一化）**：根据混合权重进行插值。
*   **Use Max Weight（使用最大权重）**：谁的权重高用谁的。
*   **Use Min Weight（使用最小权重）**：谁的权重低用谁的。

# 4. Blend Mode

**Branch Filter（分支过滤器）** 和 **Blend Mask（混合遮罩）** 都是用来定义 `Layered Blend Per Bone` 节点如何拆分骨骼范围的，但它们的工作方式、精确度和工作流有显著区别。

简单来说：**Branch Filter 是“基于树状结构的粗略划分”，而 Blend Mask 是“基于预设列表的精确控制”。**
## 1. Branch Filter (分支过滤器) —— 传统方式

这是最常用的默认方式，直接在 `Layered Blend Per Bone` 节点的细节面板里配置。

*   **工作原理**：
    你指定一个“起始骨骼”（如 `spine_01`），引擎会自动包含该骨骼及其**所有子骨骼**。
*   **关键参数 - Blend Depth（混合深度）**：
    *   如果设为 **0**：混合是“硬切”的。`spine_01` 及其子类 100% 受混合动作影响。
    *   如果设为 **正数（如 3）**：混合会产生“渐变”。例如 `spine_01` 混合 33%，`spine_02` 混合 66%，`spine_03` 混合 100%。这能让过渡更自然。
*   **优点**：
    *   设置极其快速，不需要离开动画蓝图。
    *   适合简单的全身/上半身/单手拆分。
*   **缺点**：
    *   **不够灵活**：你很难排除掉某个子分支（例如：你想混合整个右手，但不想混合右手里的某根手指）。
    *   **难以复用**：如果你有多个动画蓝图，你得在每个节点里重新填一遍骨骼名字。

## 2. Blend Mask (混合遮罩) —— 现代/资源方式

这是在 **Skeleton Editor（骨骼编辑器）** 中创建的一种 **Blend Profile（混合配置文件）**。

*   **工作原理**：
    你在骨骼树界面创建一个 `Blend Profile`，并将模式设为 `Blend Mask`。然后，你可以针对**每一根骨骼**手动输入一个权重值（0.0 到 1.0）。
*   **工作流**：
    1.  在骨骼编辑器里新建 Blend Mask。
    2.  在骨骼列表中，给需要的骨头填入数值（1 表示完全由混合层驱动，0 表示由基础层驱动）。
    3.  在动画蓝图的 `Layered Blend Per Bone` 节点上，将 `Blend Mode` 切换为 `Blend Mask`，并选择你创建的那个资源。
*   **优点**：
    *   **极度精确**：你可以精确控制每一根手指、每一根飘带的混合权重。
    *   **非层级限制**：你可以混合左手和右脚，而中间的躯干完全不动，不受骨骼树层级顺序的限制。
    *   **高度复用**：一次创建，可以在所有动画蓝图、所有节点中重复使用。
*   **缺点**：
    *   需要额外创建一个资产步骤，设置起来比 Branch Filter 慢。


---

| 特性 | Branch Filter (分支过滤器) | Blend Mask (混合遮罩) |
| :--- | :--- | :--- |
| **定义位置** | 动画蓝图节点内部 (Local) | 骨骼树资源编辑器 (Global/Asset) |
| **逻辑基础** | 父子级关系 (向下传播) | 独立的骨骼列表 (点对点) |
| **精确度** | 较低（以分支为单位） | 极高（以单根骨骼为单位） |
| **渐变控制** | 通过 Blend Depth 自动计算 | 手动为每根骨骼设置权重值 |
| **复用性** | 差（每个节点单独配） | 强（多个节点可共用一个遮罩） |
| **适用场景** | 快速实现上半身/下半身分离 | 精细的局部动作融合（如只动肩膀不动锁骨） |


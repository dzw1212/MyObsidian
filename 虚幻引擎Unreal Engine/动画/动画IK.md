在虚幻中，**IK（Inverse Kinematics，逆向动力学）** 是实现高质量、真实角色动画的核心技术之一。

# 一、 什么是 IK

在动画中，有两种基本的运动方式：

1.  **FK (Forward Kinematics，正向动力学)**：
    *   **逻辑**：从父骨骼到子骨骼。比如：旋转肩部 -> 带动大臂 -> 带动小臂 -> 最后手掌移动。
    *   **特点**：很难精确控制末端位置。如果你想让手恰好抓到桌上的杯子，用 FK 需要反复调整肩、肘、腕的三个角度。
2.  **IK (Inverse Kinematics，逆向动力学)**：
    *   **逻辑**：从子骨骼推算父骨骼。比如：你指定手掌（末端）必须在杯子的位置，算法会自动计算出肘部和肩部应该弯曲成什么角度。
    *   **特点**：**末端驱动整体**。非常适合需要与环境交互的场景。

**常见应用场景：**
*   **足部贴地（Foot Placement）**：无论地面是斜坡还是台阶，脚都能平贴地面。
*   **手部交互**：手始终握着变动的枪栓，或去按电梯按钮。
*   **注视系统**：头始终看着某个移动的目标。

---

# 二、 如何使用 IK

在虚幻引擎中，使用 IK 通常分为以下几个步骤：

1. 准备 IK 骨骼（虚拟骨骼/IK Bone）
	在骨骼树中，通常会有 `ik_foot_l`、`ik_hand_r` 等不带权重的骨骼。它们作为“目标点”存在。

2. 获取目标位置（数据采集）
	在动画蓝图（AnimBP）的 **Event Graph** 中，通过射线检测（Line Trace）获取环境信息。
	*   例子：从脚向下发出一条射线，检测地板的距离和法线（倾斜度）。

3. 在动画图表（AnimGraph）中应用 IK 节点
	将采集到的偏移量传给 IK 节点，节点会实时修改骨骼的变换（Transform）。

4. 控制权（Alpha/Alpha Clipping）
	设置权重，决定 IK 对原始动画的影响程度（比如走路时开启足部 IK，跳起悬空时关闭）。


# 三、 常用的 IK 相关节点

虚幻引擎提供了多种 IK 解算器（Solver），根据复杂度不同选择使用：

## 1. Two-Bone IK

*   **用途**：专门为人类的四肢（只有两个主要关节，如大腿和小腿、大臂和小臂）设计；
	专门用于处理由**三根骨骼、两个关节**组成的链条（例如：**大腿-小腿-脚** 或 **上臂-下臂-手掌**）。
*   **特点**：计算极其高效，效果稳定。

![250](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20260203064621.png)

### 核心原理

Two Bone IK 的计算是**解析解（Analytical Solution）**。
简单来说，给定起点（肩部）和终点（手掌目标点），以及两条骨骼的长度，系统利用三角形余弦定理直接计算出中间关节（肘部）的角度。
*   **优点**：计算速度极快，结果唯一且稳定。
*   **缺点**：只能处理正好两段骨骼的链条（不能用于脊椎或触手）。

### 关键参数

![500](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20260203064922.png)


*   **IK Bone**: 链条的末端骨骼（例如 `hand_l` 或 `foot_l`）。
	注意：节点会自动向上溯源两级，找到中点（肘/膝）和起点（肩/髋）。

**末端受力器 (Effector)**

这是你希望手/脚去往的地方。
*   **Effector Location**: 目标坐标。
*   **Effector Location Space**: 坐标空间。
    *   `World Space`: 世界空间坐标。
    *   `Component Space`: 角色根部空间（常用，较稳定）。
    *   `Bone Space`: 相对于某根骨骼的空间。

**关节目标 (Joint Target / Pole Vector)**

**这是新手最容易困惑的地方。** IK 确定了起点和终点，但肘部可以向任意方向旋转（想象手握住把手，你的肘部可以上下摆动）。
*   **Joint Target**: 强制指定肘部或膝盖应该**朝向**哪个点。
*   **Joint Target Location Space**: 同样建议使用 `Component Space` 或相对于特定的骨骼。
*   **作用**：防止膝盖向内扣或肘部奇怪地翻转。

**拉伸 (Stretching)**

当目标点（Effector）超出了手臂的总长度时，默认情况下手臂会拉直。
*   **Allow Extension**: 勾选后，允许骨骼被拉长。
*   **Max Stretch Scale**: 允许拉伸的最大比例（例如 1.2 表示最多拉长 20%）。
*   **应用场景**: 这种“橡皮筋”效果常用于卡通风格动画，或防止动画在极限位置出现剧烈抖动。

### 常见问题与调试提示

*   **肢体瞬间消失/乱跳**：
    *   通常是因为 `Effector Location Space` 设置错误（例如你传的是世界坐标，但空间选成了 Bone Space）。
    *   或者是 `Joint Target` 的位置刚好在起点和终点的连线上，导致数学计算出现奇异点。
*   **膝盖方向不对**：
    *   检查 `Joint Target` 的位置。对于腿部，目标点通常在膝盖正前方；对于手臂，通常在肘部后方或侧方。
*   **关节“砰”地一下拉直（Snapping）**：
    *   这是 IK 的固有问题。可以使用 **Enable Soft IK**（在某些版本中需要自定义逻辑或使用 FBIK）来平滑接近拉直状态的过程。

## 2. FABRIK (Forward And Backward Reaching Inverse Kinematics)

*   **用途**：用于**长链条多骨骼**（如触手、脊椎、或者超过三个关节的机械臂）。
*   **特点**：比 Two-Bone 灵活，支持任意数量的骨骼链。

## 3. CCDIK (Cyclic Coordinate Descent)

*   **用途**：常用于机械臂或工业设备的模拟。
*   **特点**：逐个骨骼迭代，计算量比 FABRIK 略大，但在约束限制下表现较好。

## 4. Full Body IK (FBIK) 

*   **用途**：全身 IK。
*   **特点**：这是目前最先进的解算器。移动一个手掌，整个身体（包括躯干和腰部）都会根据物理特性自然地做出代偿运动。
*   **环境**：通常在 **Control Rig**中使用。

## 5. Hand IK Retargeting 

*   **用途**：专门处理双手持物时的协同偏移。

用于解决**不同比例角色使用同一套动画时，手部位置对齐（尤其是握持武器）** 的问题。

![250](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20260203060028.png)


当你有一套为“标准骨骼”制作的持枪动画，但将其应用在“手臂较短”或“手臂较长”的角色上时，通常会出现以下问题：
*   **左手脱离枪身**（如果是右手主握）。
*   **手臂过度拉伸（拉直）** 导致骨骼关节出现难看的“爆关节”或抽搐。
*   **武器错位**。

**Hand IK Retargeting** 节点会自动计算主手和副手之间的相对位置，并调整 IK 骨骼（如 `ik_hand_l` 和 `ik_hand_r`）的位置，确保手部能够保持正确的间距，并根据设定的权重平滑调整手臂的拉伸感。

### 关键参数

![500](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20260203060523.png)

 **骨骼配置 (Skeleton Properties)**
 
*   **Right Hand FK / Left Hand FK**: 角色原本的手部骨骼（如 `hand_r`, `hand_l`）。
*   **Right Hand IK / Left Hand IK**: 角色对应的 IK 骨骼（如 `ik_hand_r`, `ik_hand_l`）。
*   **IKBones to Move**: 需要随之同步移动的其他 IK 骨骼。通常会把 `ik_hand_gun`（UE 默认骨骼中用于控制武器位置的虚拟骨骼）放在这里。

**权重控制 (Weighting)**

*   **Hand FKWeight**: 这是该节点**最核心**的属性。它的值通常在 0.0 到 1.0 之间：
    *   **1.0 (偏向右手)**：Retargeting 逻辑会优先保证右手的位置准确，左手会根据右手和动画源的相对距离进行偏移调整。这适用于大多数**右手持枪**的动作。
    *   **0.0 (偏向左手)**：反之，优先保证左手位置。
    *   **0.5**：在双手之间均衡调整，防止单侧手臂拉伸过猛。
    *   **动态应用**：在装弹动画中，当手离开枪支时，你可以通过动画曲线动态将此权重降为 0 或由代码控制其平滑过渡。

### 对比普通 Retargeting

| 特性       | 普通动画重定向 (IK Retargeter 资源) | Hand IK Retargeting 节点       |
| :------- | :------------------------- | :--------------------------- |
| **生效时间** | 资源生成时（离线）或全局运行时            | 每一帧根据当前姿态计算（实时）              |
| **主要目标** | 整体动作的大致匹配                  | 精确的双手间距维护（如握枪）               |
| **适用范围** | 所有的骨骼动画                    | 特别针对双手联动（Hold Weapon）的情况     |
| **灵活性**  | 固定比例                       | 可以通过 `Hand FKWeight` 动态调整主导手 |

### 实际操作建议

1.  **配合虚拟骨骼**：为了效果最好，建议在骨骼树中正确配置 `ik_hand_gun`。将枪支挂载在 `ik_hand_gun` 上，然后让这个节点来驱动 `ik_hand_gun` 的位置。
2.  **解决“爆关节”**：如果角色手臂太短，动画却要求它伸得很远，手臂会瞬间拉直导致抖动。此时减小 `Hand FKWeight` 或者调整该节点后的 IK 限制可以缓解。
3.  **AnimGraph 位置**：
    *   输入动作 -> **Hand IK Retargeting** -> **Two-Bone IK ( Arms )** -> 输出。
    *   这种顺序能确保 IK 节点拿到的是“已经修正过比例”的目标位置。

## 6. Look At

*   **用途**：一种特殊的简单 IK。
*   **特点**：让骨骼（通常是头或眼睛）始终朝向某个坐标。

## 7. Leg IK / Foot Placement

*   **用途**：虚幻 5 提供的专门用于处理腿部复杂地形贴合的节点，集成度很高。

### Foot Placement

旨在通过全自动的方式解决角色在不平整地形（如斜坡、楼梯）上的脚部对齐问题，并能自动处理“脚部锁定（Foot Locking）”以防止滑步。相比传统的“两骨骼 IK（Two Bone IK）”手动计算方法，它更智能、性能更好且设置更简单。

![200](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20260208155955.png)

#### 1. 核心功能

*   **地形自适应（Slope Warping）**：自动检测脚下地面高度和法线，调整脚部位置和旋转，使其平贴地面。
*   **脚部锁定（Foot Planting/Locking）**：在角色移动或站立时，根据速度自动判断脚部是否应该固定在地面，极大减少滑步（Foot Sliding）。
*   **盆骨补偿（Pelvis Adjustment）**：当一只脚踩在高处时，自动下拉盆骨以确保另一只脚能触地，避免角色由于腿短而产生的“拉伸”感。
*   **弹簧插值（Spring Interpolation）**：内置平滑逻辑，使脚部在跨越阶梯或颠簸地形时表现得非常顺滑，不会产生瞬间闪现。

#### 2. 关键参数详解

**Leg Definitions（腿部定义）**
这是一个数组，你需要为每一条腿添加一个定义：
*   **FK Foot Bone**：实际的脚部骨骼（如 `foot_l`）。
*   **IK Foot Bone**：对应的 IK 目标骨骼或虚拟骨骼（如 `ik_foot_l`）。
*   **Ball Bone**（可选）：脚掌/脚趾骨骼，用于更精确的脚尖对齐。

**Pelvis Settings（盆骨设置）**
*   **Max Offset**：盆骨允许移动的最大距离。如果地面落差太大，盆骨会根据这个限制向下移动以帮脚触地。
*   **Pelvis Bone**：指定盆骨骨骼（如 `pelvis`）。

**Plant Settings（锁定设置）**
*   **Speed Threshold**：速度阈值。当脚的移动速度低于此值时，系统认为脚已“落地”并开启锁定。
*   **Unplant Tick History**：用于判断脚部离开地面的历史帧数，增加稳定性。
*   **Lock Type**：可以选择锁定位置、旋转或两者。

**Trace Settings（射线检测设置）**
*   **Trace Channel**：检测地面的射线通道（通常选 `Visibility` 或自定义的 `Climbable`）。
*   **Trace Up/Down**：射线向上和向下探测的范围。

**Evaluation Mode（评估模式）**
*   **Graph Mode（图表模式）**：全自动。节点会自动通过骨骼层级关系计算脚部相对于 IK Root 的速度。
*   **Manual Mode（手动模式）**：允许你手动输入脚部速度曲线，适合需要极度精细控制（如配合 Motion Matching）的复杂项目。

### Leg IK

如果说 Foot Placement 是**大脑**（负责计算脚应该踩在哪里），那么 Leg IK 就是**肌肉**（负责真正驱动腿部骨骼弯曲，让脚到达那个位置）。

![200](https://pic-1315225359.cos.ap-shanghai.myqcloud.com/20260208160029.png)

#### 1. 核心逻辑：FK 与 IK 的桥梁

在标准的角色骨骼中，腿部是由 `Thigh（大腿）`、`Calf（小腿）` 和 `Foot（脚）` 组成的 **FK（正向动力学）** 链。
*   **问题**：Foot Placement 节点在运行时，只是修改了骨骼中的 **IK 骨骼**（如 `ik_foot_l`）的位置。如果你不使用 Leg IK，你会发现 IK 骨骼虽然动了，但角色的真腿（FK 骨骼）还是僵硬地按照原始动画播放，导致穿模或浮空。
*   **功能**：Leg IK 节点的作用是**对齐**。它会自动计算大腿和小腿的旋转角度，使 FK 的脚部骨骼强行匹配到 IK 骨骼所在的目标位置。

#### 2. 关键参数设置

**Leg Definitions（腿部定义）**
这是一个数组，通常对应左腿和右腿。每一项包含：
*   **FKFoot Bone**：实际渲染的脚骨骼（如 `foot_l`）。
*   **IKFoot Bone**：对应的 IK 目标骨骼（如 `ik_foot_l`）。
*   **Num Bones In Limb**：肢体中的骨骼数量。对于人类，通常设为 **2**（代表大腿和小腿两根骨骼）。

**Joint Target（关节目标/极向量）**
*   用于控制膝盖的朝向。在传统的 IK 算法中这叫“极向量（Pole Vector）”。
*   在 Leg IK 节点中，它通常会自动根据骨骼的弯曲方向进行处理，但你也可以手动指定参考骨骼，防止膝盖发生诡异的扭曲。

**Axis Settings（轴向设置）**
*   **Foot Rotation Axis**：指定脚部旋转的轴向，确保脚掌能正确平贴地面法线。

#### 3. Foot Placement 与 Leg IK 的协作流程

这是 UE5 官方推荐的标准动画后处理工作流：

1.  **输入动画**（状态机/混合空间）。
2.  **Local To Component**（转换到组件空间，因为 IK 计算通常在空间坐标下进行）。
3.  **Foot Placement 节点**：
    *   通过射线检测地面。
    *   **计算偏移**：算出脚应该向上抬多少或向下压多少。
    *   **更新 IK 骨骼**：把计算好的新位置写到 `ik_foot_l/r` 骨骼上。
4.  **Leg IK 节点**：
    *   **读取** `ik_foot_l/r` 的新位置。
    *   **驱动** `thigh` 和 `calf` 旋转，让 `foot` 骨骼完美重合到 IK 骨骼上。
5.  **Component To Local**（转回局部空间）。
6.  **输出结果**。

---

#### 4. 为什么不直接用wo Bone IK？

在 UE4 时代，我们常用 `Two Bone IK`。相比之下，UE5 的 **Leg IK** 具有以下优势：
*   **更高效**：一个 Leg IK 节点可以同时处理多条腿（数组形式），而 Two Bone IK 每一条腿都需要一个独立的节点。
*   **更智能**：它专门为动画扭曲（Warping）插件设计，能更好地处理伸展极限（Limb Stretching）和压缩，避免腿部在极端地形下拉长。
*   **配置简单**：不需要手动写复杂的数学公式来计算 Alpha 值或极向量。

# 四、Control Rig + IK

在 **UE5** 中，虚幻强烈建议将复杂的 IK 逻辑从动画蓝图转移到 **Control Rig** 中：

1.  **Control Rig**：是一个可视化脚本工具，你可以在其中编写逻辑：如果角色蹲下，膝盖该怎么弯，脚踝该怎么旋转。
2.  **优势**：
    *   **实时交互**：你可以在编辑器里直接拉动控件看效果。
    *   **高度复用**：一次写好，所有使用该 Rig 的角色都能直接获得完美的足部贴地效果。
    *   **高性能**：底层优化比在 AnimGraph 里叠加十几个 IK 节点要好。
